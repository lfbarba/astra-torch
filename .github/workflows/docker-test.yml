name: Docker Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-docker:
    runs-on: ubuntu-latest
    container:
      image: lfbarba/sdsc_image:1.0.0
      options: --gpus all
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Verify environment
      run: |
        python --version
        python -c "import torch; print('PyTorch version:', torch.__version__)"
        python -c "import torch; print('CUDA available:', torch.cuda.is_available())"
        python -c "import numpy; print('NumPy version:', numpy.__version__)"
        python -c "import astra; print('ASTRA Toolbox available')" || echo "ASTRA not found"
    
    - name: Install package in development mode
      run: |
        pip install -e ".[dev]"
    
    - name: Run linting (optional, may not be available in container)
      run: |
        flake8 astra_torch tests --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Skipping flake8 - not available"
        flake8 astra_torch tests --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics || echo "Skipping flake8 - not available"
      continue-on-error: true
    
    - name: Run tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Run tests with coverage (if available)
      run: |
        pytest tests/ --cov=astra_torch --cov-report=term-missing || pytest tests/ -v
      continue-on-error: true
